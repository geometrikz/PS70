<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://geometrikz.github.io/PS70/favicon.ico><title>AI Tamagotchi - PS70: Intro to Digital Fabrication</title><meta name=description content="Documenting the process of building my AI-powered tamagotchi"><meta name=author content="Geoffrey Liu"><meta name=generator content="Hugo 0.111.3"><link rel=stylesheet href="https://geometrikz.github.io/PS70/css/styles.min.b4ab39712f3739c39ef142c03628cc3e220d92e88bd8a2fec843cfbe6c05b8e0.css" integrity="sha256-tKs5cS83OcOe8ULANijMPiINkuiL2KL+yEPPvmwFuOA="><meta property="og:title" content="AI Tamagotchi"><meta property="og:description" content="Documenting the process of building my AI-powered tamagotchi"><meta property="og:type" content="article"><meta property="og:url" content="https://geometrikz.github.io/PS70/blog/final_project/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-05-07T00:00:00+00:00"><meta property="article:modified_time" content="2023-05-07T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="AI Tamagotchi"><meta name=twitter:description content="Documenting the process of building my AI-powered tamagotchi"><meta itemprop=name content="AI Tamagotchi"><meta itemprop=description content="Documenting the process of building my AI-powered tamagotchi"><meta itemprop=datePublished content="2023-05-07T00:00:00+00:00"><meta itemprop=dateModified content="2023-05-07T00:00:00+00:00"><meta itemprop=wordCount content="3306"><meta itemprop=keywords content></head><body class="dark:bg-gray-800 dark:text-white relative flex flex-col min-h-screen"><header class="container flex justify-between md:justify-between gap-4 flex-wrap p-6 mx-auto relative"><a href=https://geometrikz.github.io/PS70/ class="capitalize font-extrabold text-2xl">PS70: Intro to Digital Fabrication</a>
<button class="mobile-menu-button md:hidden"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="4" y1="8" x2="20" y2="8"/><line x1="4" y1="16" x2="20" y2="16"/></svg></button><ul class="mobile-menu absolute z-10 px-6 pb-6 md:p-0 top-full left-0 w-full md:w-auto md:relative hidden md:flex flex-col md:flex-row items-end md:items-center gap-4 lg:gap-6 bg-white dark:bg-gray-800"><li><a href=https://geometrikz.github.io/PS70/blog>Project</a></li><li><a href=https://geometrikz.github.io/PS70/page/about/>About</a></li><li class="grid place-items-center"><span class="open-search inline-block cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg></span></li><li class="grid place-items-center"><span class="toggle-dark-mode inline-block cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="3"/><line x1="12" y1="5" x2="12" y2="5.01"/><line x1="17" y1="7" x2="17" y2="7.01"/><line x1="19" y1="12" x2="19" y2="12.01"/><line x1="17" y1="17" x2="17" y2="17.01"/><line x1="12" y1="19" x2="12" y2="19.01"/><line x1="7" y1="17" x2="7" y2="17.01"/><line x1="5" y1="12" x2="5" y2="12.01"/><line x1="7" y1="7" x2="7" y2="7.01"/></svg></span></li></ul></header><main class=flex-1><div class="relative max-w-5xl mx-auto px-4"><img src=https://geometrikz.github.io/PS70/project/IMG_7475.png class="rounded-lg shadow-sm w-full object-contain"></div><div class="container flex justify-between md:justify-between gap-4 flex-wrap p-10 mx-auto relative"><article class="prose lg:prose-lg my-8 dark:prose-dark px-4 max-w-4xl mx-auto"><h1 class="text-2xl font-bold mb-2">AI Tamagotchi</h1><details id=TableOfContents class="px-4 mt-4 bg-gray-100 dark:bg-gray-700 rounded toc"><summary class="flex items-center font-bold py-2 px-4 cursor-pointer justify-between select-none text-black dark:text-white"><span>Table of contents</span><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-down" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><polyline points="6 9 12 15 18 9"/></svg></summary><ul class="mt-2 pb-4"><ul><li><a href=#motivation>Motivation</a></li><li><a href=#capbabilities>Capbabilities</a></li><li><a href=#prototype>Prototype</a><ul><ul><li><a href=#materials>Materials</a></li></ul></ul></li><li><a href=#product-design>Product design</a><ul><ul><li><a href=#first-design>First design</a></li><li><a href=#materials-1>Materials</a></li></ul></ul></li><li><a href=#second-design>Second design</a></li><li><a href=#third-design>Third design</a><ul><li><a href=#version-a>Version A</a></li></ul></li><li><a href=#final-design>Final design</a></li><li><a href=#final-product>Final Product</a></li><li><a href=#electronic-circuit>Electronic circuit</a></li></ul><li><a href=#software>Software</a></li><li><a href=#microcontroller-coding>Microcontroller coding</a><ul><li><a href=#server>Server</a></li><li><a href=#extensions>Extensions</a></li><li><a href=#cad-files>CAD Files</a></li></ul></li></ul></details><p><em>What if we could create a digital pet that you could talk to, and adapts to your personality?</em></p><video src=https://geometrikz.github.io/PS70/project/demo_video.mp4 controls style=max-width:720px></video><p><a href=https://youtu.be/-QYdDa2aF3s target=_blank rel=noopener>Backup Video Link</a></p><h2 id=motivation>Motivation</h2><p>In this course, what I found most interesting was 3D design, microcontroller programming, networking and electronic input/output devices. I also wanted to build something intricately designed and small.</p><p>Growing up, I had many different types of digital pets. The first was a <a href=https://en.wikipedia.org/wiki/Tamagotchi target=_blank rel=noopener>Tamagotchi</a>
, then it was a <a href=https://en.wikipedia.org/wiki/Digital_Monster target=_blank rel=noopener>Digimon Digivice</a>
(basically a tamagotchi that you could use to battle your friends). These were the main two hand-held devices, before digital pets were brought to a game console, such as the Nintendo DS, where I had a digital dog called <a href=https://en.wikipedia.org/wiki/Nintendogs target=_blank rel=noopener>Nintendogs</a>
, and even the Switch where I had a digital cat in <a href=https://en.wikipedia.org/wiki/Little_Friends:_Dogs_&_Cats target=_blank rel=noopener>Little Friends: Cats and Dogs</a>
.</p><p>However, there were three things lacking in all these variations of digital pets.</p><ul><li>Handheld tamagochi&rsquo;s are &ldquo;too dumb&rdquo;</li><li>Digital pets on consoles are too inconvenient</li><li>Digital pets on mobile phones are too distracting</li></ul><p>We should be able to interact with our digital pet through voice, using ChatGPT, Speech Recognition, and Speech Synthesis. In this final project, I will be documenting the process of building my AI-powered tamagotchi that you can interact with vocally.</p><h2 id=capbabilities>Capbabilities</h2><ul><li>Talk to your pet (Microphone)</li><li>Pet talks back (Speaker)</li><li>Being able to see your pet, and interact with an interface (LCD Screen)</li><li>Physical interaction (Buttons)</li><li>Wireless (Battery and WiFi)</li><li>Personality and voice recognition (Machine Learning)</li></ul><h2 id=prototype>Prototype</h2><h4 id=materials>Materials</h4><ul><li>ESP32-S2 DevKit</li><li>IMNP441 I2S Microphone</li><li>128x64 I2C OLED Display</li><li>6x6x6 Tactile Push Button</li><li>10k Ohm Resistor</li></ul><p>For the MVP prototype, I bread-boarded the electronic circuit in an attempt to get all the electronics working together. This was a good step since it allowed me to quickly diagnose circuit issues and test how many pins I would need to use in the final design.</p><p>The prototype used an I2C OLED display, 3 buttons and an I2S Microphone. At this stage, I was still troubleshooting using a speaker. Accessing the internal DAC on the ESP32-S2 DevKit was hard, and there wasn&rsquo;t much documentation and examples of how to do this online. Following the tutorials such as the one by <a href=https://circuitdigest.com/microcontroller-projects/esp32-based-audio-player target=_blank rel=noopener>Circuit Digest</a>
.</p><p>The prototype was completed using a double-stacked breadboard.</p><p><img src=https://geometrikz.github.io/PS70/project/IMG_7395.png alt=Prototype>
<img src=https://geometrikz.github.io/PS70/project/IMG_7344.png alt="Prototype with buttons"></p><p>At this stage I hadn&rsquo;t started coding yet, so I tested each component seperately using code that I wrote in previous weeks. Such as my speech recognition server in <a href=https://geometrikz.github.io/PS70/blog/week_7/ target=_blank rel=noopener>week 7</a>
and my OLED display and buttons in <a href=https://geometrikz.github.io/PS70/blog/week_4/ target=_blank rel=noopener>week 4</a>
. Everything was working at this stage apart from the speaker, so I decided to move on to finalize the software and final product design.</p><h2 id=product-design>Product design</h2><p>I went through <em>three</em> major design iterations, and around ten minor design revisions.</p><h4 id=first-design>First design</h4><p>The first design was the chunky breadboard design. I took a photo of the breadboard and used calipers to create a simple faceplate on Fusion360.</p><p><img src=https://geometrikz.github.io/PS70/project/design_v1.png alt="Prototype with case">
<img src=https://geometrikz.github.io/PS70/project/IMG_7345.png alt="Prototype with case"></p><p>This was much too large compared to my initial vision of the product. I wanted something that was small and <em>at the very least</em> could fit into my pocket. Ideally something that was Airpod or original tamagochi sized.</p><h4 id=materials-1>Materials</h4><ul><li>1x <a href="https://www.amazon.com/dp/B07R413JTD?psc=1&amp;ref=ppx_yo2ov_dt_b_product_details" target=_blank rel=noopener>1.8&amp;quot; SPI TFT LCD Display (ST7735)</a></li><li>1x <a href="https://www.amazon.com/ACEIRMC-Omnidirectional-Microphone-Interface-Supports/dp/B0963PHKS7/ref=sr_1_1?crid=2GZ9K0HKD6R3P&amp;keywords=INMP441&amp;qid=1684117424&amp;s=industrial&amp;sprefix=inmp441,industrial,76&amp;sr=1-1&amp;th=1" target=_blank rel=noopener>IMNP441 I2S Microphone</a></li><li>1x <a href="https://www.amazon.com/DMiotech-15mmx24mm-Magnetic-Internal-Loudspeaker/dp/B0BQFFH5FC/ref=sr_1_19?crid=2725Z2B43PVR0&amp;keywords=mini+speaker+arduino&amp;qid=1684117528&amp;sprefix=mini+speaker+arduino,aps,117&amp;sr=8-19" target=_blank rel=noopener>Mini 1W Speaker</a></li><li>4x <a href="https://www.amazon.com/Momentary-Tactile-Button-Switch-black/dp/B0796Q3PRB/ref=sr_1_2?crid=1PLTDRPUQ2209&amp;keywords=6x6x7+button&amp;qid=1684117661&amp;sprefix=6x6x7+button,aps,148&amp;sr=8-2" target=_blank rel=noopener>6x6x7 Tactile Push Button (4Pin)</a></li><li>1x <a href="https://www.amazon.com/EEMB-653042-Rechargeable-Connector-Certified/dp/B08HJ53Q3C/ref=sr_1_1?crid=21R9HDE78OQCO&amp;keywords=820mah+lipo&amp;qid=1684117808&amp;sprefix=820mah+lipo,aps,76&amp;sr=8-1&amp;ufe=app_do:amzn1.fos.f5122f16-c3e8-4386-bf32-63e904010ad0&amp;th=1" target=_blank rel=noopener>820mah Li-Poly Battery</a></li><li>1x <a href=https://www.adafruit.com/product/3405 target=_blank rel=noopener>Adafruit HUZZAH32</a></li></ul><h2 id=second-design>Second design</h2><p>In the second iteration, I created a finalized list of parts to use in my final project and created a design that would fit every single component perfectly with minimal loss in space.</p><p>I was inspired by the design philosophy of the <a href=https://flipperzero.one target=_blank rel=noopener>Flipper Zero</a>
. Following this inspiration, I came up with the following design. This design was very close in style to the Airpods</p><p><img src=https://geometrikz.github.io/PS70/project/design_2.png alt="Prototype V2"></p><p>However, since my components hadn&rsquo;t yet arrived I underestimated the size of each component. For example, I assumed that the screen was 1.8-2" diagonally and designed a model for that. However, when I obtained the 1.8" TFT LCD display, the diagonal size of the component was 2.7" diagonally, so the components didn&rsquo;t fit into this design. I also didn&rsquo;t take into account space for the wires and the battery. After printing out a prototype of this design, I realized that the button spacing was not correct, the microphone did not fit exactly into the holder and the speaker grill was too large.</p><p>I tried to fix these issues by scaling the design proportionally to fit the size of the screen, however the design lost its charm when it was larger since the ratio of the speaker to the screen did not look great.</p><h2 id=third-design>Third design</h2><h3 id=version-a>Version A</h3><p>In the third iteration, I decided to measure each component exactly and design mini-casings for each component shown below. I put these components next to each other into a design, which dicated how small my device could be. This also had the advantage since now I can design the casing around the components, and know that every component will fit exactly, the D-Pad was the most difficult to design and required alot of iterations since the tolerance of the buttons was very small. It was very easy for the buttons to be slightly tilted and ruin the fit and finish of the final product.</p><p><img src=https://geometrikz.github.io/PS70/project/component_cases.png alt="Prototype V3A">
<img src=https://geometrikz.github.io/PS70/project/prototype_v3a.png alt="Prototype V3A"></p><p>I didn&rsquo;t really like this layout since it makes the screen look very small, and it&rsquo;s too long and skinny. This was mainly because the screen had a very big chin from the ribbon cable and the PCB that it was attached onto (this can be seen in the asymmetrical screen casing in the image below.)</p><p>A graphic of the condensed design iteration process (minus revisions) is shown below.</p><p><img src=https://geometrikz.github.io/PS70/project/design_iteration_process.png alt="Design iterations"></p><h2 id=final-design>Final design</h2><p>After doing abit of drawing and redesign, I decided to make the screen vertical in the style of the original tamagochi. I also took advantage of the 3D aspect of the build, so I could hide unimportant components, such as the I2S Speaker Amplifier behind the screen to make the design slightly (~1mm) thicker but more compact overall.</p><p>The design consists of a front-face:</p><p><img src=https://geometrikz.github.io/PS70/project/design_v3b.png alt="Final Front Face"></p><p>A backplate which holds all the components (microphone, speaker, buttons and amplifier)</p><p><img src=https://geometrikz.github.io/PS70/project/backplate_final.png alt="Final Backplate"></p><p>And a backface which holds the battery and the ESP32.</p><p><img src=https://geometrikz.github.io/PS70/project/backface_final.png alt="Final Backface"></p><p>Everything is held in via M2 and M3 screws.</p><p>The final product design as well as a cross-section is shown below. Everything fits neatly and tightly.</p><p><img src=https://geometrikz.github.io/PS70/project/final_product.png alt="Final product"></p><p><img src=https://geometrikz.github.io/PS70/project/final_product_cross_section.png alt="Final product cross"></p><p><img src=https://geometrikz.github.io/PS70/project/final_design_split.png alt="Final product split"></p><h2 id=final-product>Final Product</h2><p>The frontface and backface were 3D printed using clear PLA, while the backplate was 3D printed using &ldquo;Silk Gold&rdquo; PLA. This was assembled and soldered manually by hand using 26 gauge copper wire. The prototype with unfinished cable management is shown below.</p><p><img src=https://geometrikz.github.io/PS70/project/IMG_7475.png alt="Final product Wires"></p><p>The final product after soldering and cable management is shown below and compared to an AirPods Pro case for size reference.</p><p><img src=https://geometrikz.github.io/PS70/project/IMG_7478.png alt="Final product 1"></p><p><img src=https://geometrikz.github.io/PS70/project/IMG_7488.png alt="Final product 2"></p><p><img src=https://geometrikz.github.io/PS70/project/IMG_7487.png alt="Final product 3"></p><h2 id=electronic-circuit>Electronic circuit</h2><p>The electronic circuit design was relatively simple since each component can be connected directly into the ESP32.</p><table><thead><tr><th>Component</th><th>ESP32 Pin</th></tr></thead><tbody><tr><td>Screen</td><td>MOSI: 18, SCLK: 5, CS: 22, RST: 19, DC: 23</td></tr><tr><td>Microphone</td><td>BCK: 27, WS: 33, DATA: 12</td></tr><tr><td>Speaker</td><td>BCK: 15, WS: 14, Data: 32</td></tr><tr><td>Buttons</td><td>R: 25, L: 4, U: 26, D:21</td></tr></tbody></table><h1 id=software>Software</h1><p>Here is a schematic of the software architecture of the project.</p><p><img src=https://geometrikz.github.io/PS70/project/system_design_v2.png alt="System Design V2"></p><h1 id=microcontroller-coding>Microcontroller coding</h1><p>The code for the microcontroller consists of three main parts.</p><ol><li>The GUI, which is implemented through conditional statements and a drawMenu() function that draws the menu based on the currentMenu and currentOption variables. The GUI is drawn using functions from the TFT_eSPI library.</li><li>HTTP request to play audio from a URL. This is done through the HTTPClient library and the I2S library.</li><li>Webserver to send microphone data to the webserver. This is done through Arduino-Audio-Tools library.</li></ol><p>The Webserver audio data transmission runs on thread 0 while the rest of the code runs on thread 1. This ensures no audio data is loss while the GUI is being drawn, the speaker is running and the buttons are pressed. This is also necessary because in order for the server to start listening to the ESP32 Microphone data, a HTTP GET request needs to be sent to the sever. This GET request and the Microphone webserver needs to run at the same time. Therefore, my code only works on multi-threaded ESP32 devices such as the ESP32 and ESP32-S3 and <em>will not work</em> on single-threaded micro-controllers.</p><details><summary>Server code (click here!)</summary><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;HTTPClient.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;ArduinoJson.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;SPI.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;TFT_eSPI.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;stdio.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&#34;pikachu.h&#34;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;Button.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span>TFT_eSPI tft <span style=color:#ff79c6>=</span> TFT_eSPI();  <span style=color:#6272a4>// Create a TFT_eSPI object
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd>int</span> currentMenu <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;       <span style=color:#6272a4>// Current selected menu
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd>int</span> currentOption <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;     <span style=color:#6272a4>// Current selected menu option
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd>int</span> currentMillis <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> screenDrawn <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span> optionsInitial[] <span style=color:#ff79c6>=</span> {<span style=color:#f1fa8c>&#34;MP3 Streamer&#34;</span>, <span style=color:#f1fa8c>&#34;Tamagochi&#34;</span>, <span style=color:#f1fa8c>&#34;AI Bot&#34;</span>, <span style=color:#f1fa8c>&#34;Settings&#34;</span>, <span style=color:#f1fa8c>&#34;Sleep&#34;</span>};<span style=color:#6272a4>// Menu 0 
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span><span style=color:#ff79c6>*</span> optionsSettings[] <span style=color:#ff79c6>=</span> {<span style=color:#f1fa8c>&#34;Volume&#34;</span>};<span style=color:#6272a4>// Menu 4 
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>const</span> <span style=color:#8be9fd>int</span> menuSizes[] <span style=color:#ff79c6>=</span> {<span style=color:#bd93f9>5</span>,<span style=color:#bd93f9>0</span>,<span style=color:#bd93f9>0</span>,<span style=color:#bd93f9>0</span>,<span style=color:#bd93f9>1</span>,<span style=color:#bd93f9>0</span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>const</span> <span style=color:#8be9fd>int</span> buttonRightPin <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>25</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>const</span> <span style=color:#8be9fd>int</span> buttonLeftPin <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>4</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>const</span> <span style=color:#8be9fd>int</span> buttonUpPin <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>26</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>const</span> <span style=color:#8be9fd>int</span> buttonDownPin <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>21</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> currentTamagochi <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span><span style=color:#6272a4>// short unsigned int *currentTamagochi = pichu;
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span>Button <span style=color:#50fa7b>buttonRight</span>(buttonRightPin);   <span style=color:#6272a4>// Power button object
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>Button <span style=color:#50fa7b>buttonLeft</span>(buttonLeftPin);         <span style=color:#6272a4>// Up button object
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>Button <span style=color:#50fa7b>buttonUp</span>(buttonUpPin);     <span style=color:#6272a4>// Down button object
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>Button <span style=color:#50fa7b>buttonDown</span>(buttonDownPin); 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> FirstTime <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&#34;AudioTools.h&#34;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span>AudioWAVServer <span style=color:#50fa7b>server</span>(<span style=color:#f1fa8c>&#34;MAKERSPACE&#34;</span>, <span style=color:#f1fa8c>&#34;12345678&#34;</span>);          <span style=color:#6272a4>// the same a above
</span></span></span><span style=display:flex><span><span style=color:#6272a4>// AudioWAVServer server(&#34;xfinitywifi_HUH_Res&#34;, &#34;huhwifi9434&#34;);
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>I2SStream i2sStream;             
</span></span><span style=display:flex><span>VolumeOutput mic_vol;
</span></span><span style=display:flex><span>StreamCopy <span style=color:#50fa7b>mic_copier</span>(mic_vol, i2sStream);                         <span style=color:#6272a4>// Access I2S as stream
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>ConverterFillLeftAndRight<span style=color:#ff79c6>&lt;</span><span style=color:#8be9fd>int16_t</span><span style=color:#ff79c6>&gt;</span> filler(RightIsEmpty);  <span style=color:#6272a4>// fill both channels - or change to RightIsEmpty
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// Speaker Stream
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&#34;AudioCodecs/CodecMP3Helix.h&#34;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>URLStream <span style=color:#50fa7b>url</span>(<span style=color:#f1fa8c>&#34;MAKERSPACE&#34;</span>, <span style=color:#f1fa8c>&#34;12345678&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#6272a4>// URLStream url(&#34;xfinitywifi_HUH_Res&#34;, &#34;huhwifi9434&#34;);
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>I2SStream i2s;                       
</span></span><span style=display:flex><span>VolumeStream <span style=color:#50fa7b>vol</span>(i2s);                 <span style=color:#6272a4>// final output of decoded stream
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>EncodedAudioStream <span style=color:#50fa7b>dec</span>(<span style=color:#ff79c6>&amp;</span>vol, <span style=color:#ff79c6>new</span> MP3DecoderHelix());  <span style=color:#6272a4>// Decoding stream
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>StreamCopy <span style=color:#50fa7b>copier</span>(dec, url);                          <span style=color:#6272a4>// copy url to decoder
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span>TaskHandle_t Task1;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setup</span>() {
</span></span><span style=display:flex><span>  <span style=color:#6272a4>// put your setup code here, to run once:
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  Serial.begin(<span style=color:#bd93f9>115200</span>);
</span></span><span style=display:flex><span>  <span style=color:#6272a4>// pinMode(buttonLeft, INPUT_PULLUP);
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  <span style=color:#6272a4>// pinMode(buttonRight, INPUT_PULLUP);
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  <span style=color:#6272a4>// pinMode(buttonUp, INPUT_PULLUP);
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  <span style=color:#6272a4>// pinMode(buttonDown, INPUT_PULLUP);
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  buttonLeft.begin();   <span style=color:#6272a4>// Initialize the power button
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  buttonRight.begin();      <span style=color:#6272a4>// Initialize the up button
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  buttonDown.begin();    <span style=color:#6272a4>// Initialize the down button
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  buttonUp.begin();      <span style=color:#6272a4>// Initialize the OK button
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span>  tft.begin();                <span style=color:#6272a4>// Initialize the TFT display
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  <span style=color:#6272a4>// tft.invertDisplay(1);
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  <span style=color:#6272a4>// tft.setRotation(2);         // Set the display rotation (if needed)
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  tft.fillScreen(TFT_BLACK);  <span style=color:#6272a4>// Set the background color
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  <span style=color:#6272a4>// delay(1000);
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  AudioLogger<span style=color:#ff79c6>::</span>instance().begin(Serial, AudioLogger<span style=color:#ff79c6>::</span>Info);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>// start i2s input with default configuration
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  Serial.println(<span style=color:#f1fa8c>&#34;starting I2S...&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>auto</span> mic_config <span style=color:#ff79c6>=</span> i2sStream.defaultConfig(RX_MODE);
</span></span><span style=display:flex><span>  mic_config.i2s_format <span style=color:#ff79c6>=</span> I2S_STD_FORMAT;  <span style=color:#6272a4>// if quality is bad change to I2S_LSB_FORMAT https://github.com/pschatzmann/arduino-audio-tools/issues/23
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  mic_config.sample_rate <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>16000</span>;
</span></span><span style=display:flex><span>  mic_config.channels <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>  mic_config.bits_per_sample <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>16</span>;
</span></span><span style=display:flex><span>  mic_config.is_master <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>true</span>;
</span></span><span style=display:flex><span>  mic_config.port_no <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>  mic_config.pin_data <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>32</span>;
</span></span><span style=display:flex><span>  mic_config.pin_bck <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>15</span>;
</span></span><span style=display:flex><span>  mic_config.pin_ws <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>14</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  i2sStream.begin(mic_config);
</span></span><span style=display:flex><span>  Serial.println(<span style=color:#f1fa8c>&#34;I2S started&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>auto</span> speaker_config <span style=color:#ff79c6>=</span> i2s.defaultConfig(TX_MODE);
</span></span><span style=display:flex><span>  speaker_config.i2s_format <span style=color:#ff79c6>=</span> I2S_STD_FORMAT;
</span></span><span style=display:flex><span>  speaker_config.pin_bck <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>27</span>;
</span></span><span style=display:flex><span>  speaker_config.pin_ws <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>33</span>;
</span></span><span style=display:flex><span>  speaker_config.pin_data <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>12</span>;
</span></span><span style=display:flex><span>  speaker_config.buffer_size <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>512</span>;
</span></span><span style=display:flex><span>  speaker_config.port_no <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#6272a4>// start data sink
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  server.begin(i2sStream, mic_config, <span style=color:#ff79c6>&amp;</span>filler);
</span></span><span style=display:flex><span>  <span style=color:#6272a4>// setup I2S based on sampling rate provided by decoder
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  i2s.begin(speaker_config);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  dec.setNotifyAudioChange(i2s);
</span></span><span style=display:flex><span>  dec.begin();
</span></span><span style=display:flex><span>  <span style=color:#6272a4>// set volume
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  vol.begin(speaker_config); <span style=color:#6272a4>// we need to provide the bits_per_sample and channels
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  vol.setVolume(<span style=color:#bd93f9>0.70</span>);
</span></span><span style=display:flex><span>  esp_sleep_enable_ext0_wakeup(GPIO_NUM_4, <span style=color:#bd93f9>0</span>); <span style=color:#6272a4>// Wakeup pin.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  <span style=color:#6272a4>// Multithreading
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  xTaskCreatePinnedToCore(
</span></span><span style=display:flex><span>    Task1code, <span style=color:#6272a4>/* Function to implement the task */</span>
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;Task1&#34;</span>, <span style=color:#6272a4>/* Name of the task */</span>
</span></span><span style=display:flex><span>    <span style=color:#bd93f9>10000</span>,  <span style=color:#6272a4>/* Stack size in words */</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>NULL</span>,  <span style=color:#6272a4>/* Task input parameter */</span>
</span></span><span style=display:flex><span>    <span style=color:#bd93f9>0</span>,  <span style=color:#6272a4>/* Priority of the task */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&amp;</span>Task1,  <span style=color:#6272a4>/* Task handle. */</span>
</span></span><span style=display:flex><span>    <span style=color:#bd93f9>0</span>); <span style=color:#6272a4>/* Core where the task should run */</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>loop</span>() {
</span></span><span style=display:flex><span>  <span style=color:#6272a4>// put your main code here, to run repeatedly:
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  <span style=color:#ff79c6>if</span> (currentMenu <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>){
</span></span><span style=display:flex><span>    drawMenu();
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>while</span>(<span style=color:#8be9fd;font-style:italic>true</span>){
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span>(buttonUp.pressed()){
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> ( currentOption <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0</span> ){
</span></span><span style=display:flex><span>          Serial.println(<span style=color:#f1fa8c>&#34;buttonUp pressed&#34;</span>);
</span></span><span style=display:flex><span>          currentOption<span style=color:#ff79c6>--</span>;
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>        currentOption <span style=color:#ff79c6>=</span> getNumOptions(currentMenu) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        drawMenu();
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span> (buttonDown.pressed()){
</span></span><span style=display:flex><span>        Serial.println(<span style=color:#f1fa8c>&#34;buttonDown pressed&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (currentOption <span style=color:#ff79c6>&lt;</span> getNumOptions(currentMenu) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>){
</span></span><span style=display:flex><span>          currentOption<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>          currentOption <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        drawMenu();
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span>(buttonRight.pressed()){
</span></span><span style=display:flex><span>        currentMenu <span style=color:#ff79c6>=</span> currentOption<span style=color:#ff79c6>+</span><span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>        drawMenu();
</span></span><span style=display:flex><span>        Serial.println(currentMenu);
</span></span><span style=display:flex><span>        currentOption <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>if</span> (currentMenu <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>1</span>){
</span></span><span style=display:flex><span>    tft.fillScreen(TFT_BLACK);
</span></span><span style=display:flex><span>    tft.setCursor(<span style=color:#bd93f9>20</span>, <span style=color:#bd93f9>10</span>);
</span></span><span style=display:flex><span>    tft.println(<span style=color:#f1fa8c>&#34;Streaming Radio&#34;</span>);
</span></span><span style=display:flex><span>    tft.setCursor(<span style=color:#bd93f9>60</span>, <span style=color:#bd93f9>80</span>);
</span></span><span style=display:flex><span>    tft.println(<span style=color:#f1fa8c>&#34;Press Right to Continue&#34;</span>);
</span></span><span style=display:flex><span>    Serial.println(<span style=color:#f1fa8c>&#34;Menu Two&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>while</span> (<span style=color:#8be9fd;font-style:italic>true</span>) {
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span> (buttonRight.pressed()){
</span></span><span style=display:flex><span>        url.begin(<span style=color:#f1fa8c>&#34;http://stream.srg-ssr.ch/m/rsj/mp3_128&#34;</span>,<span style=color:#f1fa8c>&#34;audio/mp3&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>while</span>(<span style=color:#8be9fd;font-style:italic>true</span>){
</span></span><span style=display:flex><span>          copier.copy();
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>if</span> (buttonLeft.pressed()){
</span></span><span style=display:flex><span>            url.end();
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span> (buttonLeft.pressed()){
</span></span><span style=display:flex><span>        currentMenu <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>        drawMenu();
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>if</span> (currentMenu <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>2</span>){
</span></span><span style=display:flex><span>    tft.fillScreen(TFT_BLACK);
</span></span><span style=display:flex><span>    tft.setSwapBytes(<span style=color:#8be9fd;font-style:italic>true</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span>(currentTamagochi <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>){
</span></span><span style=display:flex><span>      tft.pushImage(<span style=color:#bd93f9>20</span>, <span style=color:#bd93f9>10</span>, <span style=color:#bd93f9>96</span>, <span style=color:#bd93f9>96</span>, pichu);
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (currentTamagochi <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>1</span>){
</span></span><span style=display:flex><span>      tft.pushImage(<span style=color:#bd93f9>20</span>, <span style=color:#bd93f9>10</span>, <span style=color:#bd93f9>96</span>, <span style=color:#bd93f9>96</span>, pikachu);
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (currentTamagochi <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>2</span>){
</span></span><span style=display:flex><span>      tft.pushImage(<span style=color:#bd93f9>20</span>, <span style=color:#bd93f9>10</span>, <span style=color:#bd93f9>76</span>, <span style=color:#bd93f9>76</span>, raichu);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>    tft.setCursor(<span style=color:#bd93f9>10</span>, <span style=color:#bd93f9>120</span>);
</span></span><span style=display:flex><span>    tft.setTextColor(TFT_WHITE);
</span></span><span style=display:flex><span>    tft.println(<span style=color:#f1fa8c>&#34;Health: 8/10&#34;</span>);
</span></span><span style=display:flex><span>    tft.setCursor(<span style=color:#bd93f9>10</span>, <span style=color:#bd93f9>130</span>);
</span></span><span style=display:flex><span>    tft.println(<span style=color:#f1fa8c>&#34;Exp: 3/6&#34;</span>);
</span></span><span style=display:flex><span>    tft.setCursor(<span style=color:#bd93f9>10</span>, <span style=color:#bd93f9>140</span>);
</span></span><span style=display:flex><span>    tft.println(<span style=color:#f1fa8c>&#34;Joy: 2/5&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    tft.fillTriangle(<span style=color:#bd93f9>2</span>,<span style=color:#bd93f9>5</span>,<span style=color:#bd93f9>8</span>,<span style=color:#bd93f9>1</span>,<span style=color:#bd93f9>8</span>,<span style=color:#bd93f9>9</span>,TFT_WHITE);
</span></span><span style=display:flex><span>    tft.fillTriangle(<span style=color:#bd93f9>126</span>,<span style=color:#bd93f9>5</span>,<span style=color:#bd93f9>120</span>,<span style=color:#bd93f9>1</span>,<span style=color:#bd93f9>120</span>,<span style=color:#bd93f9>9</span>,TFT_WHITE);
</span></span><span style=display:flex><span>    tft.setCursor(<span style=color:#bd93f9>11</span>, <span style=color:#bd93f9>2</span>);
</span></span><span style=display:flex><span>    tft.print(<span style=color:#f1fa8c>&#34;Back&#34;</span>);
</span></span><span style=display:flex><span>    tft.setCursor(<span style=color:#bd93f9>50</span>, <span style=color:#bd93f9>2</span>);
</span></span><span style=display:flex><span>    tft.setTextColor(TFT_YELLOW);
</span></span><span style=display:flex><span>    tft.setTextSize(<span style=color:#bd93f9>1.5</span>);
</span></span><span style=display:flex><span>    tft.print(<span style=color:#f1fa8c>&#34;Pichu&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>while</span> (<span style=color:#8be9fd;font-style:italic>true</span>) {
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span> (buttonLeft.pressed()){
</span></span><span style=display:flex><span>        currentMenu <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>        drawMenu();
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span> (buttonRight.pressed()){
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (currentTamagochi <span style=color:#ff79c6>&lt;</span> <span style=color:#bd93f9>2</span>){
</span></span><span style=display:flex><span>          currentTamagochi<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>if</span> (currentMenu <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>3</span>){
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (buttonRight.pressed()){
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      Serial.println(<span style=color:#f1fa8c>&#34;I2S started&#34;</span>);
</span></span><span style=display:flex><span>      tft.fillScreen(TFT_BLACK);  <span style=color:#6272a4>// Clear the screen​
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>      <span style=color:#6272a4>// Draw the menu options
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>      tft.setTextSize(<span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span>      tft.setTextColor(TFT_WHITE);
</span></span><span style=display:flex><span>      tft.setCursor(<span style=color:#bd93f9>0</span>, <span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span>      vTaskResume(Task1);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#8be9fd>int</span> startMillis <span style=color:#ff79c6>=</span> millis();
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      HTTPClient http;
</span></span><span style=display:flex><span>      http.setTimeout(<span style=color:#bd93f9>100000</span>);
</span></span><span style=display:flex><span>      http.begin(<span style=color:#f1fa8c>&#34;http://192.168.0.117:8000/audio_in&#34;</span>);
</span></span><span style=display:flex><span>      http.setTimeout(<span style=color:#bd93f9>100000</span>);
</span></span><span style=display:flex><span>      http.setConnectTimeout(<span style=color:#bd93f9>100000</span>);
</span></span><span style=display:flex><span>      tft.println(<span style=color:#f1fa8c>&#34;Start speaking to me!&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#8be9fd>int</span> httpResponseCode <span style=color:#ff79c6>=</span> http.GET();
</span></span><span style=display:flex><span>      <span style=color:#6272a4>// Serial.println(&#34;Starting recognition&#34;);
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>      <span style=color:#8be9fd>int</span> currentMillis <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;  
</span></span><span style=display:flex><span>      Serial.println(httpResponseCode);
</span></span><span style=display:flex><span>      String payload <span style=color:#ff79c6>=</span> http.getString();
</span></span><span style=display:flex><span>      DynamicJsonDocument doc(<span style=color:#bd93f9>2048</span>);
</span></span><span style=display:flex><span>      DeserializationError error <span style=color:#ff79c6>=</span> deserializeJson(doc, payload);
</span></span><span style=display:flex><span>      http.end();
</span></span><span style=display:flex><span>      tft.println(<span style=color:#f1fa8c>&#34;Recorded!&#34;</span>);
</span></span><span style=display:flex><span>      vTaskSuspend(Task1);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>      tft.setCursor(<span style=color:#bd93f9>10</span>, <span style=color:#bd93f9>30</span>);
</span></span><span style=display:flex><span>      tft.println(doc[<span style=color:#f1fa8c>&#34;text&#34;</span>].as<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span>());
</span></span><span style=display:flex><span>      Serial.println(doc[<span style=color:#f1fa8c>&#34;text&#34;</span>].as<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      tft.setCursor(<span style=color:#bd93f9>10</span>, <span style=color:#bd93f9>40</span>);
</span></span><span style=display:flex><span>      tft.println(doc[<span style=color:#f1fa8c>&#34;gpt&#34;</span>].as<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span>());
</span></span><span style=display:flex><span>      Serial.println(doc[<span style=color:#f1fa8c>&#34;text&#34;</span>].as<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      delay(<span style=color:#bd93f9>500</span>);
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span>(httpResponseCode <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>200</span>){
</span></span><span style=display:flex><span>        url.begin(<span style=color:#f1fa8c>&#34;http://192.168.0.117:8000/audio_out&#34;</span>,<span style=color:#f1fa8c>&#34;audio/mp3&#34;</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#6272a4>// currentMillis = 0;
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>      
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>while</span> (<span style=color:#8be9fd;font-style:italic>true</span>){
</span></span><span style=display:flex><span>        copier.copy();
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span>(buttonLeft.pressed()){
</span></span><span style=display:flex><span>          currentMenu <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>          <span style=color:#6272a4>// drawMenu();
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>          <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      Serial.print(<span style=color:#f1fa8c>&#34;Done!&#34;</span>);
</span></span><span style=display:flex><span>      url.end();
</span></span><span style=display:flex><span>      drawMenu();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span>(buttonLeft.pressed()){
</span></span><span style=display:flex><span>      currentMenu <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>      drawMenu();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>if</span> (currentMenu <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>4</span>){
</span></span><span style=display:flex><span>    currentOption <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>    drawMenu();
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (currentOption <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>1</span>){
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>while</span>(<span style=color:#8be9fd;font-style:italic>true</span>){
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span>(buttonUp.pressed()){
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> ( currentOption <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0</span> ){
</span></span><span style=display:flex><span>          Serial.println(<span style=color:#f1fa8c>&#34;buttonUp pressed&#34;</span>);
</span></span><span style=display:flex><span>          currentOption<span style=color:#ff79c6>--</span>;
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>        currentOption <span style=color:#ff79c6>=</span> getNumOptions(currentMenu) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        drawMenu();
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span> (buttonDown.pressed()){
</span></span><span style=display:flex><span>        Serial.println(<span style=color:#f1fa8c>&#34;buttonDown pressed&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (currentOption <span style=color:#ff79c6>&lt;</span> getNumOptions(currentMenu) <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>){
</span></span><span style=display:flex><span>          currentOption<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>          currentOption <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        drawMenu();
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span>(buttonRight.pressed()){
</span></span><span style=display:flex><span>        currentMenu <span style=color:#ff79c6>=</span> currentOption<span style=color:#ff79c6>+</span><span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>        drawMenu();
</span></span><span style=display:flex><span>        Serial.println(currentMenu);
</span></span><span style=display:flex><span>        currentOption <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>if</span> (currentMenu <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>5</span>){
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>if</span> (buttonRight.pressed()){
</span></span><span style=display:flex><span>     tft.fillScreen(TFT_BLACK);
</span></span><span style=display:flex><span>     esp_deep_sleep_start();
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>if</span>(buttonLeft.pressed()){
</span></span><span style=display:flex><span>      currentMenu <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>      drawMenu();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>Task1code</span>( <span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span> pvParameters ){
</span></span><span style=display:flex><span>  Serial.print(<span style=color:#f1fa8c>&#34;Task1 running on core &#34;</span>);
</span></span><span style=display:flex><span>  Serial.println(xPortGetCoreID());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>for</span>(;;){
</span></span><span style=display:flex><span>    server.copy();
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// Serial.print(&#34;Sending audio&#34;);
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>drawMenu</span>() {
</span></span><span style=display:flex><span>  tft.fillScreen(TFT_BLACK);  <span style=color:#6272a4>// Clear the screen​
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  <span style=color:#6272a4>// Draw the menu options
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  tft.setTextSize(<span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span>  tft.setTextColor(TFT_WHITE);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>if</span> (currentMenu <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>    tft.setCursor(<span style=color:#bd93f9>5</span>, <span style=color:#bd93f9>5</span>);
</span></span><span style=display:flex><span>    tft.println(<span style=color:#f1fa8c>&#34;Select Program&#34;</span>);
</span></span><span style=display:flex><span>    tft.fillTriangle(<span style=color:#bd93f9>2</span>,<span style=color:#bd93f9>155</span>,<span style=color:#bd93f9>8</span>,<span style=color:#bd93f9>151</span>,<span style=color:#bd93f9>8</span>,<span style=color:#bd93f9>159</span>,TFT_WHITE); <span style=color:#6272a4>// Bottom Left Arrow
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    tft.setCursor(<span style=color:#bd93f9>80</span>, <span style=color:#bd93f9>152</span>);
</span></span><span style=display:flex><span>    tft.println(<span style=color:#f1fa8c>&#34;Select&#34;</span>);
</span></span><span style=display:flex><span>    tft.fillTriangle(<span style=color:#bd93f9>126</span>,<span style=color:#bd93f9>155</span>,<span style=color:#bd93f9>120</span>,<span style=color:#bd93f9>151</span>,<span style=color:#bd93f9>120</span>,<span style=color:#bd93f9>159</span>,TFT_WHITE);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (currentMenu <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>1</span>) {
</span></span><span style=display:flex><span>    tft.setCursor(<span style=color:#bd93f9>5</span>, <span style=color:#bd93f9>5</span>);
</span></span><span style=display:flex><span>    tft.println(<span style=color:#f1fa8c>&#34;Press Button to Play Music&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (currentMenu <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>2</span>) {
</span></span><span style=display:flex><span>    tft.setCursor(<span style=color:#bd93f9>5</span>, <span style=color:#bd93f9>5</span>);
</span></span><span style=display:flex><span>    tft.println(<span style=color:#f1fa8c>&#34;Press Button to see Tamagochi&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (currentMenu <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>3</span>) {
</span></span><span style=display:flex><span>    tft.setCursor(<span style=color:#bd93f9>5</span>, <span style=color:#bd93f9>5</span>);
</span></span><span style=display:flex><span>    tft.println(<span style=color:#f1fa8c>&#34;Press Button to see talk to your Tamagochi&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (currentMenu <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>4</span>) {
</span></span><span style=display:flex><span>    tft.setCursor(<span style=color:#bd93f9>5</span>, <span style=color:#bd93f9>5</span>);
</span></span><span style=display:flex><span>    tft.println(<span style=color:#f1fa8c>&#34;Settings&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (currentMenu <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>5</span>) {
</span></span><span style=display:flex><span>    tft.setCursor(<span style=color:#bd93f9>5</span>, <span style=color:#bd93f9>5</span>);
</span></span><span style=display:flex><span>    tft.println(<span style=color:#f1fa8c>&#34;Press &gt; to go to sleep&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>if</span> (currentMenu <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> getNumOptions(currentMenu); i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span> (i <span style=color:#ff79c6>==</span> currentOption) {
</span></span><span style=display:flex><span>        tft.setTextColor(TFT_YELLOW);  <span style=color:#6272a4>// Highlight the selected option
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>      } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>        tft.setTextColor(TFT_WHITE);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      tft.setCursor(<span style=color:#bd93f9>10</span>, <span style=color:#bd93f9>30</span> <span style=color:#ff79c6>+</span> i <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>20</span>);
</span></span><span style=display:flex><span>      tft.println(optionsInitial[i]);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#6272a4>// Settings
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  <span style=color:#ff79c6>if</span> (currentMenu <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>4</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> getNumOptions(currentMenu); i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span> (i <span style=color:#ff79c6>==</span> currentOption) {
</span></span><span style=display:flex><span>        tft.setTextColor(TFT_YELLOW);  <span style=color:#6272a4>// Highlight the selected option
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>      } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>        tft.setTextColor(TFT_WHITE);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      tft.setCursor(<span style=color:#bd93f9>10</span>, <span style=color:#bd93f9>30</span> <span style=color:#ff79c6>+</span> i <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>20</span>);
</span></span><span style=display:flex><span>      tft.println(optionsSettings[i]);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> <span style=color:#50fa7b>getNumOptions</span>(<span style=color:#8be9fd>int</span> menu) {
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>return</span> (<span style=color:#8be9fd>int</span>) menuSizes[menu];
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></details><h2 id=server>Server</h2><p>The server has three main functions:</p><ol><li>First, it processes the microphone data that is send by the ESP32 to text.</li><li>It then sends the text to OpenAI GPT-3.5 API to get a response.</li><li>It sends the response to Microsoft TTS server which returns an audio file of the GPT response and streams it to the ESP32.</li></ol><p>This is all done when a GET request is made by the ESP32 to <code>/audio_in/</code>, which returns the ChatGPT response in plaintext. Another GET request is made after the ESP32 receives the response to <code>/audio_out/</code>, which streams an MP3 audio file of the response to the ESP32. The code below also has an MP3 player API which can be used to stream MP3 files to the tamagotchi.</p><details><summary>Microcontroller Code (click here)</summary><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span>```python
</span></span><span style=display:flex><span><span style=color:#ff79c6>from</span> pathlib <span style=color:#ff79c6>import</span> Path
</span></span><span style=display:flex><span><span style=color:#ff79c6>from</span> fastapi <span style=color:#ff79c6>import</span> FastAPI, File, UploadFile, HTTPException, Depends, BackgroundTasks
</span></span><span style=display:flex><span><span style=color:#ff79c6>from</span> fastapi <span style=color:#ff79c6>import</span> Request, Response
</span></span><span style=display:flex><span><span style=color:#ff79c6>from</span> fastapi.responses <span style=color:#ff79c6>import</span> StreamingResponse
</span></span><span style=display:flex><span><span style=color:#ff79c6>from</span> fastapi <span style=color:#ff79c6>import</span> Header
</span></span><span style=display:flex><span><span style=color:#ff79c6>from</span> pydantic <span style=color:#ff79c6>import</span> BaseModel
</span></span><span style=display:flex><span><span style=color:#ff79c6>from</span> azure.cognitiveservices.speech.audio <span style=color:#ff79c6>import</span> AudioOutputStream
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> io
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> aiofiles
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> requests
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> pyaudio
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> azure.cognitiveservices.speech <span style=color:#ff79c6>as</span> speechsdk
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> os
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> asyncio
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> threading
</span></span><span style=display:flex><span><span style=color:#ff79c6>from</span> langchain.callbacks.base <span style=color:#ff79c6>import</span> CallbackManager
</span></span><span style=display:flex><span><span style=color:#ff79c6>from</span> langchain.callbacks.streaming_stdout <span style=color:#ff79c6>import</span> StreamingStdOutCallbackHandler
</span></span><span style=display:flex><span><span style=color:#ff79c6>from</span> langchain.chat_models <span style=color:#ff79c6>import</span> ChatOpenAI
</span></span><span style=display:flex><span><span style=color:#ff79c6>from</span> langchain.schema <span style=color:#ff79c6>import</span> (
</span></span><span style=display:flex><span>    HumanMessage,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> time
</span></span><span style=display:flex><span><span style=color:#ff79c6>from</span> langchain.llms <span style=color:#ff79c6>import</span> OpenAI
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app <span style=color:#ff79c6>=</span> FastAPI()
</span></span><span style=display:flex><span>CHUNK_SIZE <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2048</span>
</span></span><span style=display:flex><span>video_path <span style=color:#ff79c6>=</span> Path(<span style=color:#f1fa8c>&#34;creep.mp3&#34;</span>)
</span></span><span style=display:flex><span>SERVER_ADDRESS <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;http://192.168.0.248&#34;</span>
</span></span><span style=display:flex><span>url <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>{</span>SERVER_ADDRESS<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>speech_config <span style=color:#ff79c6>=</span> speechsdk<span style=color:#ff79c6>.</span>SpeechConfig(
</span></span><span style=display:flex><span>    subscription<span style=color:#ff79c6>=</span>os<span style=color:#ff79c6>.</span>environ<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#34;SPEECH_KEY&#34;</span>),
</span></span><span style=display:flex><span>    region<span style=color:#ff79c6>=</span>os<span style=color:#ff79c6>.</span>environ<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#34;SPEECH_REGION&#34;</span>),
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>chat <span style=color:#ff79c6>=</span> ChatOpenAI(
</span></span><span style=display:flex><span>    verbose<span style=color:#ff79c6>=</span><span style=color:#ff79c6>True</span>,
</span></span><span style=display:flex><span>    temperature<span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span>,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>llm <span style=color:#ff79c6>=</span> OpenAI(temperature<span style=color:#ff79c6>=</span><span style=color:#bd93f9>0.9</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>async</span> <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>generate_audio_stream</span>(text: <span style=color:#8be9fd;font-style:italic>str</span>):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    compressed_format <span style=color:#ff79c6>=</span> speechsdk<span style=color:#ff79c6>.</span>audio<span style=color:#ff79c6>.</span>AudioStreamFormat(
</span></span><span style=display:flex><span>        compressed_stream_format<span style=color:#ff79c6>=</span>speechsdk<span style=color:#ff79c6>.</span>AudioStreamContainerFormat<span style=color:#ff79c6>.</span>MP3
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    pull_stream <span style=color:#ff79c6>=</span> speechsdk<span style=color:#ff79c6>.</span>audio<span style=color:#ff79c6>.</span>PullAudioOutputStream()
</span></span><span style=display:flex><span>    <span style=color:#6272a4># Creates a speech synthesizer using pull stream as audio output.</span>
</span></span><span style=display:flex><span>    stream_config <span style=color:#ff79c6>=</span> speechsdk<span style=color:#ff79c6>.</span>audio<span style=color:#ff79c6>.</span>AudioOutputConfig(stream<span style=color:#ff79c6>=</span>pull_stream)
</span></span><span style=display:flex><span>    speech_synthesizer <span style=color:#ff79c6>=</span> speechsdk<span style=color:#ff79c6>.</span>SpeechSynthesizer(
</span></span><span style=display:flex><span>        speech_config<span style=color:#ff79c6>=</span>speech_config, audio_config<span style=color:#ff79c6>=</span>stream_config
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    result <span style=color:#ff79c6>=</span> speech_synthesizer<span style=color:#ff79c6>.</span>speak_text_async(text)<span style=color:#ff79c6>.</span>get()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> result<span style=color:#ff79c6>.</span>reason <span style=color:#ff79c6>==</span> speechsdk<span style=color:#ff79c6>.</span>ResultReason<span style=color:#ff79c6>.</span>SynthesizingAudioCompleted:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>audio_stream_generator</span>():
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>while</span> <span style=color:#ff79c6>True</span>:
</span></span><span style=display:flex><span>                audio_chunk <span style=color:#ff79c6>=</span> pull_stream<span style=color:#ff79c6>.</span>read(<span style=color:#bd93f9>1024</span>)
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>not</span> audio_chunk:
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>break</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>yield</span> audio_chunk
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> Response(audio_stream_generator(), media_type<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;audio/wav&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>else</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> {<span style=color:#f1fa8c>&#34;error&#34;</span>: <span style=color:#f1fa8c>&#34;TTS failed&#34;</span>, <span style=color:#f1fa8c>&#34;details&#34;</span>: result<span style=color:#ff79c6>.</span>error_details}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>async</span> <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>speech_synthesis_to_mp3_file</span>(text):
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;&#34;&#34;performs speech synthesis to a mp3 file&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># Creates an instance of a speech config with specified subscription key and service region.</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># Sets the synthesis output format.</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># The full list of supported format can be found here:</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># https://docs.microsoft.com/azure/cognitive-services/speech-service/rest-text-to-speech#audio-outputs</span>
</span></span><span style=display:flex><span>    speech_config<span style=color:#ff79c6>.</span>set_speech_synthesis_output_format(
</span></span><span style=display:flex><span>        speechsdk<span style=color:#ff79c6>.</span>SpeechSynthesisOutputFormat<span style=color:#ff79c6>.</span>Audio16Khz32KBitRateMonoMp3
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#6272a4># Creates a speech synthesizer using file as audio output.</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># Replace with your own audio file name.</span>
</span></span><span style=display:flex><span>    file_name <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;outputaudio.mp3&#34;</span>
</span></span><span style=display:flex><span>    file_config <span style=color:#ff79c6>=</span> speechsdk<span style=color:#ff79c6>.</span>audio<span style=color:#ff79c6>.</span>AudioOutputConfig(filename<span style=color:#ff79c6>=</span>file_name)
</span></span><span style=display:flex><span>    speech_synthesizer <span style=color:#ff79c6>=</span> speechsdk<span style=color:#ff79c6>.</span>SpeechSynthesizer(
</span></span><span style=display:flex><span>        speech_config<span style=color:#ff79c6>=</span>speech_config, audio_config<span style=color:#ff79c6>=</span>file_config
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># Receives a text from console input and synthesizes it to mp3 file.</span>
</span></span><span style=display:flex><span>    result <span style=color:#ff79c6>=</span> speech_synthesizer<span style=color:#ff79c6>.</span>speak_text_async(text)<span style=color:#ff79c6>.</span>get()
</span></span><span style=display:flex><span>    <span style=color:#6272a4># Check result</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> result<span style=color:#ff79c6>.</span>reason <span style=color:#ff79c6>==</span> speechsdk<span style=color:#ff79c6>.</span>ResultReason<span style=color:#ff79c6>.</span>SynthesizingAudioCompleted:
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>print</span>(
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;Speech synthesized for text [</span><span style=color:#f1fa8c>{}</span><span style=color:#f1fa8c>], and the audio was saved to [</span><span style=color:#f1fa8c>{}</span><span style=color:#f1fa8c>]&#34;</span><span style=color:#ff79c6>.</span>format(
</span></span><span style=display:flex><span>                text, file_name
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>elif</span> result<span style=color:#ff79c6>.</span>reason <span style=color:#ff79c6>==</span> speechsdk<span style=color:#ff79c6>.</span>ResultReason<span style=color:#ff79c6>.</span>Canceled:
</span></span><span style=display:flex><span>        cancellation_details <span style=color:#ff79c6>=</span> result<span style=color:#ff79c6>.</span>cancellation_details
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;Speech synthesis canceled: </span><span style=color:#f1fa8c>{}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>.</span>format(cancellation_details<span style=color:#ff79c6>.</span>reason))
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> cancellation_details<span style=color:#ff79c6>.</span>reason <span style=color:#ff79c6>==</span> speechsdk<span style=color:#ff79c6>.</span>CancellationReason<span style=color:#ff79c6>.</span>Error:
</span></span><span style=display:flex><span>            <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;Error details: </span><span style=color:#f1fa8c>{}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>.</span>format(cancellation_details<span style=color:#ff79c6>.</span>error_details))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>async</span> <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>preload_audio</span>(text: <span style=color:#8be9fd;font-style:italic>str</span>):
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>await</span> speech_synthesis_to_mp3_file(text)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>async</span> <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>send_to_gpt</span>(text: <span style=color:#8be9fd;font-style:italic>str</span>):
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>await</span> chat([HumanMessage(content<span style=color:#ff79c6>=</span>text)])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@app.get(<span style=color:#f1fa8c>&#34;/tts&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>async</span> <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>text_to_speech</span>(text: <span style=color:#8be9fd;font-style:italic>str</span>):
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>await</span> generate_audio_stream(text)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>class</span> <span style=color:#50fa7b>ChatMessage</span>(BaseModel):
</span></span><span style=display:flex><span>    message: <span style=color:#8be9fd;font-style:italic>str</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@app.post(<span style=color:#f1fa8c>&#34;/upload/&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>async</span> <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>upload_file</span>(file: UploadFile <span style=color:#ff79c6>=</span> File(<span style=color:#ff79c6>...</span>)):
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> file<span style=color:#ff79c6>.</span>filename<span style=color:#ff79c6>.</span>endswith(<span style=color:#f1fa8c>&#34;.mp3&#34;</span>):
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> {<span style=color:#f1fa8c>&#34;filename&#34;</span>: file<span style=color:#ff79c6>.</span>filename}
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>else</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>raise</span> HTTPException(status_code<span style=color:#ff79c6>=</span><span style=color:#bd93f9>400</span>, detail<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;File must be in MP3 format&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@app.post(<span style=color:#f1fa8c>&#34;/uploadandplay/&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>async</span> <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>upload_file</span>(file: UploadFile <span style=color:#ff79c6>=</span> File(<span style=color:#ff79c6>...</span>)):
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> file<span style=color:#ff79c6>.</span>filename<span style=color:#ff79c6>.</span>endswith(<span style=color:#f1fa8c>&#34;.mp3&#34;</span>):
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> {<span style=color:#f1fa8c>&#34;filename&#34;</span>: file<span style=color:#ff79c6>.</span>filename}
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>else</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>raise</span> HTTPException(status_code<span style=color:#ff79c6>=</span><span style=color:#bd93f9>400</span>, detail<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;File must be in MP3 format&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>async</span> <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>file_streamer</span>(filename: <span style=color:#8be9fd;font-style:italic>str</span>):
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>async</span> <span style=color:#ff79c6>with</span> aiofiles<span style=color:#ff79c6>.</span>open(filename, mode<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;rb&#34;</span>) <span style=color:#ff79c6>as</span> f:
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>while</span> <span style=color:#ff79c6>True</span>:
</span></span><span style=display:flex><span>                chunk <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>await</span> f<span style=color:#ff79c6>.</span>read(<span style=color:#bd93f9>1024</span>)
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>not</span> chunk:
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>break</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>yield</span> chunk
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>except</span> FileNotFoundError:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>raise</span> HTTPException(status_code<span style=color:#ff79c6>=</span><span style=color:#bd93f9>404</span>, detail<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;File not found&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@app.get(<span style=color:#f1fa8c>&#34;/stream/</span><span style=color:#f1fa8c>{filename}</span><span style=color:#f1fa8c>&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>async</span> <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>stream_audio</span>(filename: <span style=color:#8be9fd;font-style:italic>str</span>):
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>iterfile</span>():
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>with</span> <span style=color:#8be9fd;font-style:italic>open</span>(filename, mode<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;rb&#34;</span>) <span style=color:#ff79c6>as</span> f:
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>while</span> chunk <span style=color:#ff79c6>:=</span> f<span style=color:#ff79c6>.</span>read(CHUNK_SIZE):
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>yield</span> chunk
</span></span><span style=display:flex><span>            <span style=color:#6272a4># yield from file_like</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> StreamingResponse(iterfile(), media_type<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;audio/mpeg&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>async</span> <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>speech_recognition_with_push_stream</span>():
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;&#34;&#34;gives an example how to use a push audio stream to recognize speech from a custom audio
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    source&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    CHUNK <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1024</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>push_stream_writer</span>(url, stream, recognition_done):
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>try</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>with</span> requests<span style=color:#ff79c6>.</span>get(url, stream<span style=color:#ff79c6>=</span><span style=color:#ff79c6>True</span>) <span style=color:#ff79c6>as</span> response:
</span></span><span style=display:flex><span>                response<span style=color:#ff79c6>.</span>raise_for_status()
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>for</span> chunk <span style=color:#ff79c6>in</span> response<span style=color:#ff79c6>.</span>iter_content(chunk_size<span style=color:#ff79c6>=</span>CHUNK):
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>if</span> (
</span></span><span style=display:flex><span>                        recognition_done<span style=color:#ff79c6>.</span>is_set()
</span></span><span style=display:flex><span>                    ):  <span style=color:#6272a4># Check if the recognition_done event is set</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>break</span>
</span></span><span style=display:flex><span>                    stream<span style=color:#ff79c6>.</span>write(chunk)
</span></span><span style=display:flex><span>                stream<span style=color:#ff79c6>.</span>close()
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>finally</span>:
</span></span><span style=display:flex><span>            stream<span style=color:#ff79c6>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    speech_config <span style=color:#ff79c6>=</span> speechsdk<span style=color:#ff79c6>.</span>SpeechConfig(
</span></span><span style=display:flex><span>        subscription<span style=color:#ff79c6>=</span>os<span style=color:#ff79c6>.</span>environ<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#34;SPEECH_KEY&#34;</span>),
</span></span><span style=display:flex><span>        region<span style=color:#ff79c6>=</span>os<span style=color:#ff79c6>.</span>environ<span style=color:#ff79c6>.</span>get(<span style=color:#f1fa8c>&#34;SPEECH_REGION&#34;</span>),
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#6272a4># setup the audio stream</span>
</span></span><span style=display:flex><span>    stream <span style=color:#ff79c6>=</span> speechsdk<span style=color:#ff79c6>.</span>audio<span style=color:#ff79c6>.</span>PushAudioInputStream()
</span></span><span style=display:flex><span>    audio_config <span style=color:#ff79c6>=</span> speechsdk<span style=color:#ff79c6>.</span>audio<span style=color:#ff79c6>.</span>AudioConfig(stream<span style=color:#ff79c6>=</span>stream)
</span></span><span style=display:flex><span>    <span style=color:#6272a4># instantiate the speech recognizer with push stream input</span>
</span></span><span style=display:flex><span>    speech_recognizer <span style=color:#ff79c6>=</span> speechsdk<span style=color:#ff79c6>.</span>SpeechRecognizer(
</span></span><span style=display:flex><span>        speech_config<span style=color:#ff79c6>=</span>speech_config, audio_config<span style=color:#ff79c6>=</span>audio_config
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    recognition_done <span style=color:#ff79c6>=</span> threading<span style=color:#ff79c6>.</span>Event()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># # Connect callbacks to the events fired by the speech recognizer</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>session_stopped_cb</span>(evt):
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;&#34;&#34;callback that signals to stop continuous recognition upon receiving an event `evt`&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;SESSION STOPPED: </span><span style=color:#f1fa8c>{}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>.</span>format(evt))
</span></span><span style=display:flex><span>        recognition_done<span style=color:#ff79c6>.</span>set()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    speech_recognizer<span style=color:#ff79c6>.</span>recognized<span style=color:#ff79c6>.</span>connect(
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>lambda</span> evt: <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;RECOGNIZED: </span><span style=color:#f1fa8c>{}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>.</span>format(evt))
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    speech_recognizer<span style=color:#ff79c6>.</span>session_started<span style=color:#ff79c6>.</span>connect(
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>lambda</span> evt: <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;SESSION STARTED: </span><span style=color:#f1fa8c>{}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>.</span>format(evt))
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    speech_recognizer<span style=color:#ff79c6>.</span>session_stopped<span style=color:#ff79c6>.</span>connect(session_stopped_cb)
</span></span><span style=display:flex><span>    <span style=color:#6272a4># start push stream writer thread</span>
</span></span><span style=display:flex><span>    push_stream_writer_thread <span style=color:#ff79c6>=</span> threading<span style=color:#ff79c6>.</span>Thread(
</span></span><span style=display:flex><span>        target<span style=color:#ff79c6>=</span>push_stream_writer, args<span style=color:#ff79c6>=</span>[url, stream, recognition_done]
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    push_stream_writer_thread<span style=color:#ff79c6>.</span>start()
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;Recognizing speech:&#34;</span>)
</span></span><span style=display:flex><span>    result_future <span style=color:#ff79c6>=</span> speech_recognizer<span style=color:#ff79c6>.</span>recognize_once_async()
</span></span><span style=display:flex><span>    result <span style=color:#ff79c6>=</span> result_future<span style=color:#ff79c6>.</span>get()
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> result<span style=color:#ff79c6>.</span>reason <span style=color:#ff79c6>==</span> speechsdk<span style=color:#ff79c6>.</span>ResultReason<span style=color:#ff79c6>.</span>RecognizedSpeech:
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;Recognized: </span><span style=color:#f1fa8c>{}</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>.</span>format(result<span style=color:#ff79c6>.</span>text))
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;Done recognizing&#34;</span>)
</span></span><span style=display:flex><span>    push_stream_writer_thread<span style=color:#ff79c6>.</span>join()
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;Finished&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> result
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>class</span> <span style=color:#50fa7b>TestResponse</span>:
</span></span><span style=display:flex><span>    text <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;Give me a 10 word idea!&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>async</span> <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>send_to_gpt</span>(text: <span style=color:#8be9fd;font-style:italic>str</span>):
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> llm<span style=color:#ff79c6>.</span>generate([<span style=color:#f1fa8c>&#34;Keep answer to less than 20 words: &#34;</span> <span style=color:#ff79c6>+</span> text])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@app.get(<span style=color:#f1fa8c>&#34;/audio_in&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>async</span> <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>read_audio</span>(background_tasks: BackgroundTasks):
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span>:
</span></span><span style=display:flex><span>        result <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>await</span> speech_recognition_with_push_stream()
</span></span><span style=display:flex><span>        resp <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>await</span> send_to_gpt(result<span style=color:#ff79c6>.</span>text)
</span></span><span style=display:flex><span>        background_tasks<span style=color:#ff79c6>.</span>add_task(preload_audio, resp<span style=color:#ff79c6>.</span>generations[<span style=color:#bd93f9>0</span>][<span style=color:#bd93f9>0</span>]<span style=color:#ff79c6>.</span>text)
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>print</span>(resp<span style=color:#ff79c6>.</span>generations[<span style=color:#bd93f9>0</span>][<span style=color:#bd93f9>0</span>]<span style=color:#ff79c6>.</span>text)
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> {<span style=color:#f1fa8c>&#34;text&#34;</span>: result<span style=color:#ff79c6>.</span>text, <span style=color:#f1fa8c>&#34;gpt&#34;</span>: resp<span style=color:#ff79c6>.</span>generations[<span style=color:#bd93f9>0</span>][<span style=color:#bd93f9>0</span>]<span style=color:#ff79c6>.</span>text}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>except</span> Exception <span style=color:#ff79c6>as</span> e:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>raise</span> HTTPException(status_code<span style=color:#ff79c6>=</span><span style=color:#bd93f9>500</span>, detail<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>str</span>(e))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@app.get(<span style=color:#f1fa8c>&#34;/audio_out&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>async</span> <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>stream_audio</span>():
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> StreamingResponse(file_streamer(<span style=color:#f1fa8c>&#34;outputaudio.mp3&#34;</span>), media_type<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;audio/mpeg&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@app.get(<span style=color:#f1fa8c>&#34;/test_read&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>async</span> <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>read_audio</span>():
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> {<span style=color:#f1fa8c>&#34;status&#34;</span>: <span style=color:#f1fa8c>&#34;success&#34;</span>, <span style=color:#f1fa8c>&#34;message&#34;</span>: <span style=color:#f1fa8c>&#34;Hello!&#34;</span>}
</span></span></code></pre></div></details><h2 id=extensions>Extensions</h2><p>In the next version of the design, here are a few changes I would make</p><ol><li>Reduce space and make the edges curved (similar to the Airpods/Tamagochi case)</li><li>Design a PCB to hold all the components together and make the design more compact</li><li>Use surface-mount devices instead of stock components.</li><li>Add a BMP280 so the AI can see altitude and temperature information. One of the most asked questions was &ldquo;what is the weather like today&rdquo;, which it currently cannot answer accurately.</li><li>Bluetooth to piggy back off phone connectivity (?)</li></ol><h2 id=cad-files>CAD Files</h2><p><a href=https://geometrikz.github.io/PS70/project/tamagotchi_v8.f3d>Download my Fusion360 CAD file here</a>
<a href=https://geometrikz.github.io/PS70/project/tamagotchi_v8.stl>Download the final STL file here</a></p></article></div><hr class="relative h-px my-8 bg-gray-200 border-0 dark:bg-gray-700 max-w-4xl mx-auto"><div class="giscus w-full mx-auto pt-4 max-w-4xl"><script>function changeGiscusTheme(){const e=document.documentElement.getAttribute("class")==="dark"?"light":"dark";function t(e){const t=document.querySelector("iframe.giscus-frame");if(!t)return;t.contentWindow.postMessage({giscus:e},"https://giscus.app")}t({setConfig:{theme:e}})}const modeToggle=document.querySelector(".toggle-dark-mode");modeToggle&&modeToggle.addEventListener("click",changeGiscusTheme)</script><script>let giscusTheme=localStorage.getItem("darkmode"),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"geometrikz/ps70","data-repo-id":"R_kgDOI6narQ","data-category":"Announcements","data-category-id":"DIC_kwDOI6narc4CUEG2","data-mapping":"title","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-theme":giscusTheme,"data-lang":"en",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([e,t])=>giscusScript.setAttribute(e,t)),document.body.appendChild(giscusScript)</script></div></main><footer class="container p-6 mx-auto flex justify-between items-center"><span class="text-sm font-light">2023 © PS70: Intro to Digital Fabrication</span>
<span onclick='window.scrollTo({top:0,behavior:"smooth"})' class="p-1 cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18 15l-6-6-6 6h12"/></svg></span></footer><div class="search-ui absolute top-0 left-0 w-full h-full bg-white dark:bg-gray-800 hidden"><div class="container max-w-3xl mx-auto p-12"><div class=relative><div class="my-4 text-center text-2xl font-bold">Search</div><span class="p-2 absolute right-0 top-0 cursor-pointer close-search"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></span></div><input type=search class="py-2 px-3 w-full dark:text-black border dark:border-transparent" placeholder="Enter search query"><div class="search-results text-lg font-medium my-4 hidden">Results</div><ul class="search-list my-2"></ul><div class="no-results text-center my-8 hidden"><div class="text-xl font-semibold mb-2">No results found</div><p class="font-light text-sm">Try adjusting your search query</p></div></div></div><script src=https://geometrikz.github.io/PS70/js/scripts.min.js></script>
<script>const darkmode=document.querySelector(".toggle-dark-mode");function toggleDarkMode(){document.documentElement.classList.contains("dark")?(document.documentElement.classList.remove("dark"),localStorage.setItem("darkmode","light")):(document.documentElement.classList.add("dark"),localStorage.setItem("darkmode","dark"))}darkmode&&darkmode.addEventListener("click",toggleDarkMode);const darkStorage=localStorage.getItem("darkmode"),isBrowserDark=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;!darkStorage&&isBrowserDark&&document.documentElement.classList.add("dark"),darkStorage&&darkStorage==="dark"&&toggleDarkMode()</script><script>const mobileMenuButton=document.querySelector(".mobile-menu-button"),mobileMenu=document.querySelector(".mobile-menu");function toggleMenu(){mobileMenu.classList.toggle("hidden"),mobileMenu.classList.toggle("flex")}mobileMenu&&mobileMenuButton&&mobileMenuButton.addEventListener("click",toggleMenu)</script></body></html>